{% extends 'base.html' %}

{% block content %}
<style>
    /* ë””ìì¸: ê²€ìƒ‰ì°½ ë†’ì´ ì¡°ì ˆ */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
        padding-top: 4px;
        border: 1px solid #ced4da;
    }
    /* ê²€ìƒ‰ ê²°ê³¼ ê¸€ì ìŠ¤íƒ€ì¼ */
    .select2-results__option {
        font-size: 0.95rem;
        padding: 8px 12px;
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">ğŸ”— ê±°ë˜ì²˜-í’ˆëª© ë§¤í•‘ ê´€ë¦¬</h2>
        <a href="/masters/upload/" class="btn btn-outline-success">ğŸ“‚ ì—‘ì…€ë¡œ ì¼ê´„ ì˜¬ë¦¬ê¸°</a>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-light py-3">
            <h5 class="mb-0 fw-bold">â• ë§¤í•‘ ì§ì ‘ ì¶”ê°€</h5>
        </div>
        <div class="card-body">
            <form method="post" class="row g-3 align-items-end">
                {% csrf_token %}
                
                <div class="col-md-5">
                    <label class="form-label fw-bold">ê±°ë˜ì²˜ ê²€ìƒ‰</label>
                    <select name="customer" class="form-select select2-customer" required>
                        <option value="">ê±°ë˜ì²˜ëª… ì…ë ¥ (1ê¸€ì ì´ìƒ)...</option>
                    </select>
                </div>
                
                <div class="col-md-5">
                    <label class="form-label fw-bold">í’ˆëª© ê²€ìƒ‰</label>
                    <select name="product" class="form-select select2-product" required>
                        <option value="">í’ˆëª©ëª… ë˜ëŠ” ì½”ë“œ ì…ë ¥...</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">ì—°ê²°í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">ğŸ“‹ ì—°ê²°ëœ ëª©ë¡ ({{ mappings.count }}ê±´)</h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0 text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 30%;">ê±°ë˜ì²˜ëª…</th>
                        <th style="width: 30%;">í’ˆëª©ëª…</th>
                        <th style="width: 15%;">SKU ì½”ë“œ</th>
                        <th style="width: 15%;">ë‹¨ê°€</th>
                        <th style="width: 10%;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in mappings %}
                    <tr>
                        <td class="fw-bold">{{ m.customer.name }}</td>
                        <td class="text-start ps-4">{{ m.product.name }}</td>
                        <td><span class="badge bg-light text-dark border">{{ m.product.sku }}</span></td>
                        <td>{{ m.product.unit_price }}ì›</td>
                        <td>
                            <a href="{% url 'customer-product-delete' m.pk %}" 
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('ì •ë§ [{{ m.customer.name }} - {{ m.product.name }}] ì—°ê²°ì„ í•´ì œí• ê¹Œìš”?');">
                                ì‚­ì œ
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="py-5 text-muted">
                            <h5 class="fw-bold">ì•„ì§ ì—°ê²°ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</h5>
                            <p class="mb-0">ìœ„ ê²€ìƒ‰ì°½ì—ì„œ ê±°ë˜ì²˜ì™€ í’ˆëª©ì„ ê²€ìƒ‰í•´ì„œ ì—°ê²°í•´ì£¼ì„¸ìš”.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ko.js"></script>

<script>
    $(document).ready(function() {
        
        // ê³µí†µ ì˜µì…˜: ëœì»¥ê±°ë¦¼ ë°©ì§€ ì„¤ì • ì •ì˜
        const commonOptions = {
            theme: 'bootstrap-5',
            allowClear: true,
            width: '100%',
            minimumInputLength: 0, // í´ë¦­ ì‹œ ë°”ë¡œ ëª©ë¡ ë…¸ì¶œ
            language: {
                // â˜… [í•µì‹¬] ê²€ìƒ‰ ì¤‘ì¼ ë•Œ ì•„ë¬´ ê¸€ìë„ ì•ˆ ë‚˜ì˜¤ê²Œ í•´ì„œ ë¦¬ìŠ¤íŠ¸ ë°€ë¦¼ ë°©ì§€
                searching: function() {
                    return ""; 
                },
                // ê²°ê³¼ ì—†ì„ ë•Œ ë¬¸êµ¬
                noResults: function() {
                    return "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤";
                }
            }
        };

        // 1. ê±°ë˜ì²˜ ê²€ìƒ‰ (ì„¤ì • ì ìš©)
        $('.select2-customer').select2({
            ...commonOptions, // ìœ„ì—ì„œ ì •ì˜í•œ ì˜µì…˜ ê°€ì ¸ì˜¤ê¸°
            placeholder: "ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”",
            ajax: {
                url: '/api/masters/search/customers/',
                dataType: 'json',
                delay: 250,
                data: function (params) { return { q: params.term }; },
                processResults: function (data) { return { results: data.results }; },
                cache: true
            }
        });

        // 2. í’ˆëª© ê²€ìƒ‰ (ì„¤ì • ì ìš©)
        $('.select2-product').select2({
            ...commonOptions, // ìœ„ì—ì„œ ì •ì˜í•œ ì˜µì…˜ ê°€ì ¸ì˜¤ê¸°
            placeholder: "í’ˆëª©ì„ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”",
            ajax: {
                url: '/api/masters/search/products/',
                dataType: 'json',
                delay: 250,
                data: function (params) { return { q: params.term }; },
                processResults: function (data) { return { results: data.results }; },
                cache: true
            }
        });
    });
</script>
{% endblock %}