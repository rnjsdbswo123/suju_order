{% extends 'base.html' %}

{% block content %}
<style>
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner-container {
        display: none;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 255, 255, 0.7);
        z-index: 1050;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* ë‘ ê°œì˜ ë¦¬ìŠ¤íŠ¸ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .dual-listbox {
        display: flex;
        justify-content: space-between;
    }
    .dual-listbox .list-box {
        width: 45%;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        height: 500px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .dual-listbox .list-box-header {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    .dual-listbox select[multiple] {
        width: 100%;
        height: 100%;
        border-radius: 5px;
        border-color: #ced4da;
    }
    .dual-listbox option {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .dual-listbox option:hover {
        background-color: #f0f0f0;
    }
    .dual-listbox .filter-input {
        margin-bottom: 10px;
    }

    /* ì´ë™ ë²„íŠ¼ */
    .dual-listbox .buttons {
        width: 10%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .dual-listbox .buttons button {
        margin: 10px 0;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        font-weight: bold;
    }
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
        padding-top: 4px;
        border: 1px solid #ced4da;
    }
</style>

<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">ğŸ” ê±°ë˜ì²˜-í’ˆëª© ë§¤í•‘ ê´€ë¦¬ (ê°œì„ )</h2>
    </div>

    <!-- ê±°ë˜ì²˜ ì„ íƒ -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light py-3">
            <h5 class="mb-0 fw-bold">1. ê±°ë˜ì²˜ ì„ íƒ</h5>
        </div>
        <div class="card-body">
            <select id="customer-select" class="form-select">
                <option value="">ê±°ë˜ì²˜ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
        </div>
    </div>

    <!-- í’ˆëª© ë§¤í•‘ UI -->
    <div id="mapping-ui" style="display: none;">
        <div class="card shadow-sm position-relative">
             <div class="card-header bg-light py-3">
                <h5 class="mb-0 fw-bold">2. í’ˆëª© ë§¤í•‘</h5>
            </div>
            <div class="card-body">
                <div class="dual-listbox">
                    <!-- ë“±ë¡ëœ í’ˆëª© -->
                    <div class="list-box">
                        <div class="list-box-header text-primary">
                            <i class="fas fa-link"></i> ë“±ë¡ëœ í’ˆëª© (<span id="mapped-count">0</span>)
                        </div>
                        <input type="text" id="mapped-filter" class="form-control filter-input" placeholder="í•„í„°...">
                        <select id="mapped-products" multiple class="form-select"></select>
                    </div>

                    <!-- ë²„íŠ¼ -->
                    <div class="buttons">
                        <button id="add-btn" class="btn btn-outline-secondary">&lt;</button>
                        <button id="remove-btn" class="btn btn-outline-secondary">&gt;</button>
                    </div>

                    <!-- ë“±ë¡ ê°€ëŠ¥í•œ í’ˆëª© -->
                    <div class="list-box">
                        <div class="list-box-header text-success">
                            <i class="fas fa-puzzle-piece"></i> ë“±ë¡ ê°€ëŠ¥í•œ í’ˆëª© (<span id="available-count">0</span>)
                        </div>
                        <input type="text" id="available-filter" class="form-control filter-input" placeholder="í•„í„°...">
                        <select id="available-products" multiple class="form-select"></select>
                    </div>
                </div>
            </div>
            <div class="card-footer text-end">
                <button id="save-btn" class="btn btn-primary btn-lg fw-bold px-4">
                    <i class="fas fa-save"></i> ì €ì¥í•˜ê¸°
                </button>
            </div>
            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
            <div class="spinner-container" id="spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ko.js"></script>

<!-- Font Awesome ì•„ì´ì½˜ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

<script>
$(document).ready(function() {
    // ===================================================================
    // 1. ì´ˆê¸°í™” ë° ë³€ìˆ˜ ì„ ì–¸
    // ===================================================================
    const customerSelect = $('#customer-select');
    const mappingUI = $('#mapping-ui');
    const availableProductsSelect = $('#available-products');
    const mappedProductsSelect = $('#mapped-products');
    const availableFilter = $('#available-filter');
    const mappedFilter = $('#mapped-filter');
    const addBtn = $('#add-btn');
    const removeBtn = $('#remove-btn');
    const saveBtn = $('#save-btn');
    const spinner = $('#spinner');
    
    let allProducts = []; // ì „ì²´ í’ˆëª© ë¦¬ìŠ¤íŠ¸ (ìºì‹œ)
    let currentCustomerId = null;

    // ===================================================================
    // 2. Select2 ê±°ë˜ì²˜ ê²€ìƒ‰ ì´ˆê¸°í™”
    // ===================================================================
    customerSelect.select2({
        theme: 'bootstrap-5',
        placeholder: "ê±°ë˜ì²˜ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”",
        language: "ko",
        ajax: {
            url: '/masters/api/search/customers/',
            dataType: 'json',
            delay: 250,
            data: function(params) { return { q: params.term }; },
            processResults: function(data) { return { results: data.results }; },
            cache: true
        }
    });

    // ===================================================================
    // 3. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    // ===================================================================

    // ê±°ë˜ì²˜ ì„ íƒ ì‹œ
    customerSelect.on('select2:select', function(e) {
        currentCustomerId = e.params.data.id;
        if (currentCustomerId) {
            mappingUI.show();
            loadProductsForCustomer(currentCustomerId);
        } else {
            mappingUI.hide();
        }
    });

    // í•„í„°ë§
    mappedFilter.on('keyup', () => filterProducts(mappedFilter, mappedProductsSelect));
    availableFilter.on('keyup', () => filterProducts(availableFilter, availableProductsSelect));

    // í’ˆëª© ì´ë™
    addBtn.on('click', () => moveSelected(availableProductsSelect, mappedProductsSelect));
    removeBtn.on('click', () => moveSelected(mappedProductsSelect, availableProductsSelect));
    
    // ë”ë¸”í´ë¦­ìœ¼ë¡œ ì´ë™
    mappedProductsSelect.on('dblclick', () => moveSelected(mappedProductsSelect, availableProductsSelect));
    availableProductsSelect.on('dblclick', () => moveSelected(availableProductsSelect, mappedProductsSelect));

    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
    saveBtn.on('click', saveMappings);

    // ===================================================================
    // 4. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜
    // ===================================================================

    // í’ˆëª© ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ë° ë¶„ë°°
    async function loadProductsForCustomer(customerId) {
        spinner.show();
        try {
            // 1. ì „ì²´ í’ˆëª© ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìºì‹œëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´)
            if (allProducts.length === 0) {
                const productsResponse = await $.ajax({ url: '/masters/api/search/products/' });
                allProducts = productsResponse.results.map(p => ({
                    id: p.id,
                    // "í’ˆëª©ëª… (SKU)" í˜•ì‹ì—ì„œ ì´ë¦„ë§Œ ì¶”ì¶œ
                    text: p.text.split(' (')[0]
                }));
            }
            
            // 2. í•´ë‹¹ ê±°ë˜ì²˜ì— ë§¤í•‘ëœ í’ˆëª© ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const mappedResponse = await $.ajax({ url: `/masters/api/customers/${customerId}/products/` });
            const mappedProductIds = new Set(mappedResponse.map(p => p.id));
            
            // 3. í’ˆëª© ë¶„ë°°
            const availableProducts = [];
            const mappedProducts = [];
            
            allProducts.forEach(product => {
                if (mappedProductIds.has(parseInt(product.id))) {
                    mappedProducts.push(product);
                } else {
                    availableProducts.push(product);
                }
            });

            // 4. í™”ë©´ì— ë Œë”ë§
            renderProducts(mappedProductsSelect, mappedProducts);
            renderProducts(availableProductsSelect, availableProducts);

        } catch (error) {
            console.error("Error loading products:", error);
            alert("í’ˆëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        } finally {
            spinner.hide();
        }
    }

    // ë¦¬ìŠ¤íŠ¸ ë°•ìŠ¤ì— í’ˆëª© ë Œë”ë§
    function renderProducts(selectElement, products) {
        selectElement.empty();
        products.sort((a, b) => a.text.localeCompare(b.text, 'ko')); // ê°€ë‚˜ë‹¤ ìˆœ ì •ë ¬
        products.forEach(p => {
            selectElement.append(`<option value="${p.id}">${p.text}</option>`);
        });
        updateCounts();
    }
    
    // í’ˆëª© í•„í„°ë§
    function filterProducts(filterInput, selectElement) {
        const filterValue = filterInput.val().toLowerCase();
        selectElement.find('option').each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.includes(filterValue));
        });
    }

    // ì„ íƒëœ í’ˆëª© ì´ë™
    function moveSelected(fromSelect, toSelect) {
        fromSelect.find('option:selected').detach().appendTo(toSelect);
        filterProducts(mappedFilter, mappedProductsSelect); // ì´ë™ í›„ í•„í„° ì¬ì ìš©
        filterProducts(availableFilter, availableProductsSelect);
        sortSelect(toSelect);
        updateCounts();
    }
    
    // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì˜µì…˜ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
    function sortSelect(selectElement) {
        selectElement.html(selectElement.find('option').sort((a, b) => {
            return a.text.localeCompare(b.text, 'ko');
        }));
    }

    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    function updateCounts() {
        $('#mapped-count').text(mappedProductsSelect.find('option').length);
        $('#available-count').text(availableProductsSelect.find('option').length);
    }
    
    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCsrfToken() {
        return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }

    // ë³€ê²½ì‚¬í•­ ì €ì¥
    function saveMappings() {
        if (!currentCustomerId) {
            alert("ë¨¼ì € ê±°ë˜ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }
        
        spinner.show();
        
        const mappedProductIds = mappedProductsSelect.find('option').map(function() {
            return $(this).val();
        }).get();

        $.ajax({
            url: `/masters/api/update-customer-products/`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                customer_id: currentCustomerId,
                product_ids: mappedProductIds
            }),
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            success: function(response) {
                spinner.hide();
                alert(response.message || 'ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                // í•„ìš” ì‹œ, ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                loadProductsForCustomer(currentCustomerId);
            },
            error: function(xhr, status, error) {
                spinner.hide();
                console.error("Save error:", error);
                const errorMsg = xhr.responseJSON?.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                alert(errorMsg);
            }
        });
    }
});
</script>
{% endblock %}
