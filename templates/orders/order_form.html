{% extends 'base.html' %}

{% block content %}
<style>
    /* Select2 ë””ìì¸ */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
        padding-top: 4px;
        border: 1px solid #ced4da;
    }
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        color: #333;
        padding-left: 10px;
    }
    .product-row input { text-align: right; }
</style>

{# ìˆ˜ì • ëª¨ë“œì¼ ê²½ìš°, Django order ê°ì²´ë¥¼ Javascript ê°ì²´ë¡œ ë³€í™˜ #}
<script>
    {% if order_data %}
    const EDIT_ORDER = {{ order_data|json_script:"edit-order-data" }};
    {% else %}
    const EDIT_ORDER = null;
    {% endif %}
</script>

<div class="container mt-4" style="max-width: 800px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0">ğŸ“ ë°œì£¼ì„œ ì‘ì„±</h3>
        <div class="d-flex gap-2">
            <a href="{% url 'my-order-list' %}" class="btn btn-outline-primary fw-bold">
                ğŸ“‹ ë‚˜ì˜ ë°œì£¼ ë‚´ì—­
            </a>
            <a href="{% url 'production:production-status-ui' %}" class="btn btn-primary fw-bold">
                ğŸ“Š ìˆ˜ì£¼ í˜„í™©íŒ ê°€ê¸°
            </a>
        </div>
    </div>
    
    <div class="card p-4 shadow-sm">
        <form id="orderForm">
            <div class="mb-4">
                <label class="form-label fw-bold">ê±°ë˜ì²˜ ê²€ìƒ‰</label>
                <select id="customer-select" class="form-select" style="width: 100%;" required>
                    <option value="" selected disabled>ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    {% if customers %}
                        {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</option>
                    {% endif %}
                </select>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold">ìƒì‚°ì¼</label>
                    <input type="date" id="delivery_date" class="form-control" required {% if min_date %}min="{{ min_date }}" value="{{ min_date }}"{% endif %}>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">ì „ë‹¬ ì‚¬í•­</label>
                <input type="text" id="memo" class="form-control" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥ (ì„ íƒ)">
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold">ì£¼ë¬¸ í’ˆëª©</label>
                <div class="text-end mb-2">
                    <a id="mapping-button" href="{% url 'customer-product-manage' %}" class="btn btn-outline-secondary fw-bold px-3 py-2">&#44144;&#47000;&#52376; &#54408;&#47785; &#47588;&#54053;</a>
                </div>
                <div id="product-list-area" class="border p-3 rounded bg-light text-center text-muted">
                    ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ë©´ í’ˆëª© ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 fw-bold fs-5">ğŸš€ ë°œì£¼ ë“±ë¡ ì™„ë£Œ</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ko.js"></script>

<script>
    const IS_PRIVILEGED = {{ is_privileged_user|yesno:"true,false" }};
    const csrftoken = getCookie('csrftoken');
    const PRODUCT_ORDER_KEY_PREFIX = 'order-form-product-order:';
    let currentCustomerId = null;
    const mappingButton = document.getElementById('mapping-button');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateMappingButton(customerId) {
        if (!mappingButton) return;
        if (customerId) {
            mappingButton.href = `/masters/mapping/?customer_id=${customerId}`;
            mappingButton.classList.remove('disabled');
        } else {
            mappingButton.href = "{% url 'customer-product-manage' %}";
            mappingButton.classList.add('disabled');
        }
    }

    $(document).ready(function() {
        const isEditMode = typeof EDIT_ORDER !== 'undefined' && EDIT_ORDER !== null;
        
        // 1. ê±°ë˜ì²˜ ê²€ìƒ‰ ì„¤ì •
        $('#customer-select').select2({
            theme: 'bootstrap-5',
            placeholder: "ê±°ë˜ì²˜ëª… ê²€ìƒ‰...",
            allowClear: true,
            width: '100%',
            language: "ko",
            minimumResultsForSearch: 0
        });
        updateMappingButton($('#customer-select').val());

        // 2. ìˆ˜ì • ëª¨ë“œ ì²˜ë¦¬
        if (isEditMode) {
            $('.fw-bold.m-0').text('âœï¸ ë°œì£¼ì„œ ìˆ˜ì •');
            $('button[type="submit"]').html('ğŸ’¾ ìˆ˜ì • ì™„ë£Œ');
            
            // ê±°ë˜ì²˜ ì„ íƒ ë° ë¹„í™œì„±í™”
            $('#customer-select').val(EDIT_ORDER.customer.id).trigger('change').prop('disabled', true);
            
            // ë‚©ê¸°ì¼, ë©”ëª¨ ì„¤ì •
            $('#delivery_date').val(EDIT_ORDER.requested_delivery_date);
            $('#memo').val(EDIT_ORDER.memo);

            // í’ˆëª© ë¡œë“œ ë° ìˆ˜ëŸ‰ ì±„ìš°ê¸°
            loadProducts(EDIT_ORDER.customer.id, () => {
                EDIT_ORDER.lines.forEach(line => {
                    const productRow = $(`.product-item[data-id="${line.product.id}"]`);
                    if (productRow.length) {
                        productRow.find('.qty-input').val(line.requested_quantity);
                    }
                });
            });

        }
        
        // 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        $('#customer-select').on('select2:select', function (e) {
            if (!isEditMode) {
                loadProducts(e.params.data.id);
            }
            updateMappingButton(e.params.data.id);
        });
        $('#customer-select').on('select2:clear', function () {
            updateMappingButton(null);
        });

        $('#orderForm').on('submit', function(e) {
            e.preventDefault();
            submitOrder(isEditMode);
        });

        if (mappingButton) {
            mappingButton.addEventListener('click', function (e) {
                const customerId = $('#customer-select').val();
                if (!customerId) {
                    e.preventDefault();
                    alert('ê±°ë˜ì²˜ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
                }
            });
        }
    });


    function loadProducts(customerId, callback) {
        currentCustomerId = customerId;
        updateMappingButton(customerId);
        fetch(`/masters/api/customers/${customerId}/products/`)
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('product-list-area');
            container.innerHTML = ""; 
            container.classList.remove('text-center', 'text-muted');

            if (data.length === 0) {
                container.innerHTML = '<p class="text-danger text-center fw-bold">âš ï¸ ë“±ë¡ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const orderedProducts = applyStoredProductOrder(data, customerId);
            orderedProducts.forEach(p => {
                container.innerHTML += `
                    <div class="d-flex align-items-center justify-content-between mb-2 p-2 border-bottom product-item" data-id="${p.id}">
                        <div class="d-flex align-items-center">
                            <div class="me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveUp(this)">â–²</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveDown(this)">â–¼</button>
                            </div>
                            <span class="fw-bold" style="font-size: 1rem;">${p.name}</span> 
                        </div>
                        <div style="width: 140px;">
                            <input type="number" class="form-control text-end fw-bold qty-input" style="font-size:1.2rem;" placeholder="0" min="0">
                        </div>
                    </div>
                `;
            });

            if (callback) callback();
        });
    }

    function moveUp(btn) {
        const row = btn.closest('.product-item');
        if (row.previousElementSibling) {
            row.parentNode.insertBefore(row, row.previousElementSibling);
            saveCurrentProductOrder();
        }
    }

    function moveDown(btn) {
        const row = btn.closest('.product-item');
        if (row.nextElementSibling) {
            row.parentNode.insertBefore(row.nextElementSibling, row);
            saveCurrentProductOrder();
        }
    }

    function getStoredProductOrder(customerId) {
        if (!customerId) return [];
        try {
            const raw = localStorage.getItem(PRODUCT_ORDER_KEY_PREFIX + customerId);
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed.map(String) : [];
        } catch (e) {
            return [];
        }
    }

    function applyStoredProductOrder(products, customerId) {
        const storedOrder = getStoredProductOrder(customerId);
        if (storedOrder.length === 0) return products;

        const productMap = new Map();
        products.forEach(p => productMap.set(String(p.id), p));

        const ordered = [];
        storedOrder.forEach(id => {
            if (productMap.has(id)) {
                ordered.push(productMap.get(id));
                productMap.delete(id);
            }
        });

        productMap.forEach(p => ordered.push(p));
        return ordered;
    }

    function saveCurrentProductOrder() {
        if (!currentCustomerId) return;
        const orderedIds = Array.from(document.querySelectorAll('.product-item'))
            .map(row => row.dataset.id);
        localStorage.setItem(PRODUCT_ORDER_KEY_PREFIX + currentCustomerId, JSON.stringify(orderedIds));
    }

    function submitOrder(isEditMode) {
        const customerId = $('#customer-select').val();
        if(!customerId) { alert("ê±°ë˜ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }

        const items = [];
        document.querySelectorAll('.product-item').forEach(row => {
            const qty = row.querySelector('.qty-input').value;
            if(qty && parseInt(qty) >= 0) { // ìˆ˜ì • ì‹œ 0ìœ¼ë¡œ ë§Œë“œëŠ” ê²½ìš°ë„ í¬í•¨
                items.push({ product_id: row.dataset.id, quantity: qty });
            }
        });

        if(items.length === 0) { alert("ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        
        let url, method;
        if (isEditMode) {
            url = `/orders/api/update/${EDIT_ORDER.id}/`;
            method = 'POST'; // or 'PUT'
        } else {
            url = '/orders/api/create/';
            method = 'POST';
        }

        const payload = {
            customer_id: customerId,
            delivery_date: document.getElementById('delivery_date').value,
            memo: document.getElementById('memo').value,
            items: items
        };

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(payload)
        }).then(res => {
            if(res.ok) { 
                res.json().then(data => {
                    alert(data.message);
                    window.location.href = "{% url 'my-order-list' %}";
                });
            } else { 
                res.json().then(err => alert("ì˜¤ë¥˜: " + err.error));
            }
        });
    }
</script>
{% endblock %}
