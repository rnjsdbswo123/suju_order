{% extends 'base.html' %}

{% block content %}
<style>
    /* Select2 ë””ìì¸ */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
        padding-top: 4px;
        border: 1px solid #ced4da;
    }
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        color: #333;
        padding-left: 10px;
    }
    .product-row input { text-align: right; }
</style>

{# ìˆ˜ì • ëª¨ë“œì¼ ê²½ìš°, Django order ê°ì²´ë¥¼ Javascript ê°ì²´ë¡œ ë³€í™˜ #}
<script>
    {% if order_data %}
    const EDIT_ORDER = {{ order_data|json_script:"edit-order-data" }};
    {% else %}
    const EDIT_ORDER = null;
    {% endif %}
</script>

<div class="container mt-4" style="max-width: 800px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0">ğŸ“ ë°œì£¼ì„œ ì‘ì„±</h3>
        <div class="d-flex gap-2">
            <a href="{% url 'my-order-list' %}" class="btn btn-outline-primary fw-bold">
                ğŸ“‹ ë‚˜ì˜ ë°œì£¼ ë‚´ì—­
            </a>
            <a href="{% url 'production:production-status-ui' %}" class="btn btn-primary fw-bold">
                ğŸ“Š ìˆ˜ì£¼ í˜„í™©íŒ ê°€ê¸°
            </a>
        </div>
    </div>
    
    <div class="card p-4 shadow-sm">
        <form id="orderForm">
            <div class="mb-4">
                <label class="form-label fw-bold">ê±°ë˜ì²˜ ê²€ìƒ‰</label>
                <select id="customer-select" class="form-select" style="width: 100%;" required>
                    <option value="" selected disabled>ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    {% if customers %}
                        {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</option>
                    {% endif %}
                </select>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold">ë‚©ê¸° ìš”ì²­ì¼</label>
                    <input type="date" id="delivery_date" class="form-control" required>
                    <small id="date-warning" class="text-danger fw-bold" style="display:none;">â€» 15ì‹œ ë§ˆê°ìœ¼ë¡œ ëª¨ë ˆë¶€í„° ê°€ëŠ¥</small>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">ì „ë‹¬ ì‚¬í•­</label>
                <input type="text" id="memo" class="form-control" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥ (ì„ íƒ)">
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold">ì£¼ë¬¸ í’ˆëª©</label>
                <div id="product-list-area" class="border p-3 rounded bg-light text-center text-muted">
                    ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ë©´ í’ˆëª© ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 fw-bold fs-5">ğŸš€ ë°œì£¼ ë“±ë¡ ì™„ë£Œ</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ko.js"></script>

<script>
    const IS_PRIVILEGED = {{ is_privileged_user|yesno:"true,false" }};
    const csrftoken = getCookie('csrftoken');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $(document).ready(function() {
        const isEditMode = typeof EDIT_ORDER !== 'undefined' && EDIT_ORDER !== null;
        
        // 1. ê±°ë˜ì²˜ ê²€ìƒ‰ ì„¤ì •
        $('#customer-select').select2({
            theme: 'bootstrap-5',
            placeholder: "ê±°ë˜ì²˜ëª… ê²€ìƒ‰...",
            allowClear: true,
            width: '100%',
            language: "ko",
            minimumResultsForSearch: 0
        });

        // 2. ìˆ˜ì • ëª¨ë“œ ì²˜ë¦¬
        if (isEditMode) {
            $('.fw-bold.m-0').text('âœï¸ ë°œì£¼ì„œ ìˆ˜ì •');
            $('button[type="submit"]').html('ğŸ’¾ ìˆ˜ì • ì™„ë£Œ');
            
            // ê±°ë˜ì²˜ ì„ íƒ ë° ë¹„í™œì„±í™”
            $('#customer-select').val(EDIT_ORDER.customer.id).trigger('change').prop('disabled', true);
            
            // ë‚©ê¸°ì¼, ë©”ëª¨ ì„¤ì •
            $('#delivery_date').val(EDIT_ORDER.requested_delivery_date);
            $('#memo').val(EDIT_ORDER.memo);

            // í’ˆëª© ë¡œë“œ ë° ìˆ˜ëŸ‰ ì±„ìš°ê¸°
            loadProducts(EDIT_ORDER.customer.id, () => {
                EDIT_ORDER.lines.forEach(line => {
                    const productRow = $(`.product-item[data-id="${line.product.id}"]`);
                    if (productRow.length) {
                        productRow.find('.qty-input').val(line.requested_quantity);
                    }
                });
            });

        } else {
            // ìƒì„± ëª¨ë“œ: 15ì‹œ ë§ˆê° ë¡œì§ ì²´í¬
            checkTimeAndSetDate();
        }
        
        // 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        $('#customer-select').on('select2:select', function (e) {
            if (!isEditMode) {
                loadProducts(e.params.data.id);
            }
        });

        $('#orderForm').on('submit', function(e) {
            e.preventDefault();
            submitOrder(isEditMode);
        });
    });

    // 15ì‹œ ì²´í¬ í•¨ìˆ˜
    function checkTimeAndSetDate() {
        if (EDIT_ORDER) return; // ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ë‚ ì§œë¥¼ ë°”ê¾¸ì§€ ì•ŠìŒ
        
        const dateInput = document.getElementById('delivery_date');
        const warning = document.getElementById('date-warning');

        if (IS_PRIVILEGED) {
            warning.style.display = 'none';
            let today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.min = `${yyyy}-${mm}-${dd}`;
            if (!dateInput.value) { dateInput.value = `${yyyy}-${mm}-${dd}`; }
            return;
        }

        const now = new Date();
        const hour = now.getHours();
        let targetDate = new Date();
        
        if (hour >= 15) {
            targetDate.setDate(now.getDate() + 2);
            warning.style.display = 'block'; 
        } else {
            targetDate.setDate(now.getDate() + 1);
            warning.style.display = 'none';
        }

        const yyyy = targetDate.getFullYear();
        const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
        const dd = String(targetDate.getDate()).padStart(2, '0');
        const strDate = `${yyyy}-${mm}-${dd}`;

        dateInput.value = strDate;
        dateInput.min = strDate; 
    }

    function loadProducts(customerId, callback) {
        fetch(`/masters/api/customers/${customerId}/products/`)
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('product-list-area');
            container.innerHTML = ""; 
            container.classList.remove('text-center', 'text-muted');

            if (data.length === 0) {
                container.innerHTML = '<p class="text-danger text-center fw-bold">âš ï¸ ë“±ë¡ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            data.forEach(p => {
                container.innerHTML += `
                    <div class="d-flex align-items-center justify-content-between mb-2 p-2 border-bottom product-item" data-id="${p.id}">
                        <div class="d-flex align-items-center">
                            <div class="me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveUp(this)">â–²</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveDown(this)">â–¼</button>
                            </div>
                            <span class="fw-bold" style="font-size: 1rem;">${p.name}</span> 
                        </div>
                        <div style="width: 140px;">
                            <input type="number" class="form-control text-end fw-bold qty-input" style="font-size:1.2rem;" placeholder="0" min="0">
                        </div>
                    </div>
                `;
            });

            if (callback) callback();
        });
    }

    function moveUp(btn) {
        const row = btn.closest('.product-item');
        if (row.previousElementSibling) {
            row.parentNode.insertBefore(row, row.previousElementSibling);
        }
    }

    function moveDown(btn) {
        const row = btn.closest('.product-item');
        if (row.nextElementSibling) {
            row.parentNode.insertBefore(row.nextElementSibling, row);
        }
    }

    function submitOrder(isEditMode) {
        const customerId = $('#customer-select').val();
        if(!customerId) { alert("ê±°ë˜ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }

        const items = [];
        document.querySelectorAll('.product-item').forEach(row => {
            const qty = row.querySelector('.qty-input').value;
            if(qty && parseInt(qty) >= 0) { // ìˆ˜ì • ì‹œ 0ìœ¼ë¡œ ë§Œë“œëŠ” ê²½ìš°ë„ í¬í•¨
                items.push({ product_id: row.dataset.id, quantity: qty });
            }
        });

        if(items.length === 0) { alert("ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        
        let url, method;
        if (isEditMode) {
            url = `/orders/api/update/${EDIT_ORDER.id}/`;
            method = 'POST'; // or 'PUT'
        } else {
            url = '/orders/api/create/';
            method = 'POST';
        }

        const payload = {
            customer_id: customerId,
            delivery_date: document.getElementById('delivery_date').value,
            memo: document.getElementById('memo').value,
            items: items
        };

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(payload)
        }).then(res => {
            if(res.ok) { 
                res.json().then(data => {
                    alert(data.message);
                    window.location.href = "{% url 'my-order-list' %}";
                });
            } else { 
                res.json().then(err => alert("ì˜¤ë¥˜: " + err.error));
            }
        });
    }
</script>
{% endblock %}