{% extends 'base.html' %}
{% block content %}
<style>
    /* í…Œì´ë¸” ìƒíƒœë³„ ë°°ê²½ìƒ‰ ìŠ¤íƒ€ì¼ */
    .table-green { background-color: #d1e7dd !important; --bs-table-bg: #d1e7dd !important; }
    .table-green:hover { background-color: #badbcc !important; --bs-table-bg: #badbcc !important; }
    .table-red { background-color: #ffe5d0 !important; --bs-table-bg: #ffe5d0 !important; }
    .table-red:hover { background-color: #ffd6b3 !important; --bs-table-bg: #ffd6b3 !important; }
    .table-yellow { background-color: #fff3cd !important; --bs-table-bg: #fff3cd !important; }
    .table-yellow:hover { background-color: #ffe69c !important; --bs-table-bg: #ffe69c !important; }
    
    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .nav-pills .nav-link.active { background-color: #0d6efd; }
    .nav-pills .nav-link { color: #495057; background-color: #fff; border: 1px solid #dee2e6; margin-right: 5px; }
    
    /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
    .search-input { width: 250px; }
</style>

<div style="display:none;"><form id="csrf-form">{% csrf_token %}</form></div>

<div class="container-fluid mt-4">
    
    <div id="update-notification" class="alert alert-info fw-bold text-center" style="display: none;" role="alert">
        <!-- New items notification will be inserted here by JavaScript -->
    </div>

    <div class="bg-white shadow-sm rounded border mb-4">
        <div class="d-flex justify-content-between align-items-center p-4 border-bottom">
            <div class="d-flex align-items-center gap-2">
                <span style="font-size: 2rem;">ğŸ­</span>
                <div>
                    <h2 class="fw-bold m-0 text-dark">ìƒì‚° í˜„í™©íŒ</h2>
                    <small class="text-muted">ì‹¤ì‹œê°„ ì£¼ë¬¸ ë° ì‘ì—… í˜„í™©</small>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2">
                <a href="/orders/new/" class="btn btn-primary fw-bold shadow-sm">+ ì‹ ê·œ ë°œì£¼ ë“±ë¡</a>
                <a href="/orders/my-list/" class="btn btn-outline-secondary fw-bold">ğŸ“‹ ë‚´ ë°œì£¼ ë³´ê¸°</a>
                
                <div class="vr mx-2"></div> 
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger text-nowrap">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center px-4 py-2 bg-light rounded-bottom">
            <div class="d-flex align-items-center gap-2">
                <span class="small fw-bold text-muted me-2">ğŸ“Œ ìƒíƒœ ì•ˆë‚´:</span>
                <span class="badge bg-white text-dark border">â¬œ ëŒ€ê¸°</span>
                <span class="badge text-dark border" style="background-color: #d1e7dd;">ğŸŸ© ì •ìƒ ì™„ë£Œ</span>
                <span class="badge text-dark border" style="background-color: #ffe5d0;">ğŸŸ§ ìˆ˜ëŸ‰ ë¶ˆì¼ì¹˜</span>
            </div>
            <div>
                <button class="btn btn-warning btn-sm fw-bold shadow-sm" onclick="openPendingModal()">ë¯¸ìƒì‚° ëª©ë¡</button>
                <button class="btn btn-info btn-sm fw-bold shadow-sm" onclick="openBulkEditModal()">
                    âœï¸ ì²´í¬ëœ í•­ëª© ì¼ê´„ ìˆ˜ì •
                </button>
                <button class="btn btn-success btn-sm fw-bold shadow-sm" onclick="completeBulk()">
                    âœ… ì²´í¬ëœ í•­ëª© ì¼ê´„ ì™„ë£Œ
                </button>
            </div>
        </div>
    </div>

    <ul class="nav nav-pills mb-3">
        <li class="nav-item">
            <a class="nav-link {% if selected_facility == 'ALL' %}active{% endif %}" href="?date={{ selected_date }}&facility=ALL&q={{ search_query }}&status={{ selected_status }}&group_by={{ group_by }}&sort={{ sort_by }}&dir={{ sort_dir }}">ì „ì²´ ê³µì¥</a>
        </li>
        {% for fac in facility_list %}
        <li class="nav-item">
            <a class="nav-link {% if selected_facility == fac %}active{% endif %}" href="?date={{ selected_date }}&facility={{ fac }}&q={{ search_query }}&status={{ selected_status }}&group_by={{ group_by }}&sort={{ sort_by }}&dir={{ sort_dir }}">{{ fac }}</a>
        </li>
        {% endfor %}
    </ul>

    <div class="d-flex align-items-center mb-3 justify-content-between">
        <div class="d-flex align-items-center">
            <strong class="me-3">ìƒíƒœ:</strong>
            <div class="btn-group btn-group-lg">
                <a href="?date={{ selected_date }}&facility={{ selected_facility }}&q={{ search_query }}&status=all&group_by={{ group_by }}&sort={{ sort_by }}&dir={{ sort_dir }}" class="btn {% if selected_status == 'all' or not selected_status %}btn-primary{% else %}btn-outline-secondary{% endif %} fw-bold">ì „ì²´</a>
                <a href="?date={{ selected_date }}&facility={{ selected_facility }}&q={{ search_query }}&status=incomplete&group_by={{ group_by }}&sort={{ sort_by }}&dir={{ sort_dir }}" class="btn {% if selected_status == 'incomplete' %}btn-danger{% else %}btn-outline-secondary{% endif %} fw-bold">ë¯¸ì™„ë£Œ</a>
                <a href="?date={{ selected_date }}&facility={{ selected_facility }}&q={{ search_query }}&status=completed&group_by={{ group_by }}&sort={{ sort_by }}&dir={{ sort_dir }}" class="btn {% if selected_status == 'completed' %}btn-success{% else %}btn-outline-secondary{% endif %} fw-bold">ì™„ë£Œ</a>
            </div>
        </div>
        <div>
            <strong class="me-3">ë¬¶ìŒ ê¸°ì¤€:</strong>
            <div class="btn-group btn-group-lg" role="group">
                <a href="?date={{ selected_date }}&facility={{ selected_facility }}&q={{ search_query }}&status={{ selected_status }}&group_by=product" class="btn {% if group_by == 'product' %}btn-primary{% else %}btn-outline-secondary{% endif %} fw-bold">í’ˆëª©ë³„</a>
                <a href="?date={{ selected_date }}&facility={{ selected_facility }}&q={{ search_query }}&status={{ selected_status }}&group_by=customer" class="btn {% if group_by == 'customer' %}btn-primary{% else %}btn-outline-secondary{% endif %} fw-bold">ê±°ë˜ì²˜ë³„</a>
                <a href="?date={{ selected_date }}&facility={{ selected_facility }}&q={{ search_query }}&status={{ selected_status }}&group_by=time" class="btn {% if group_by == 'time' %}btn-primary{% else %}btn-outline-secondary{% endif %} fw-bold">ë°œì£¼ì‹œê°„ìˆœ</a>
            </div>
        </div>
    </div>

    <div class="card mb-4 border-0 shadow-sm bg-light">
        <div class="card-body py-3">
            <form method="get" action="." class="row g-2 align-items-center">
                <input type="hidden" name="facility" value="{{ selected_facility }}">
                <input type="hidden" name="group_by" value="{{ group_by }}">
                
                <div class="col-auto"><label class="fw-bold">ğŸ“… ìƒì‚°ì¼:</label></div>
                <div class="col-auto">
                    <input type="date" name="date" class="form-control" value="{% if selected_date != 'ALL' %}{{ selected_date }}{% endif %}">
                </div>
                
                <div class="col-auto ms-3"><label class="fw-bold">ğŸ” í†µí•© ê²€ìƒ‰:</label></div>
                <div class="col-auto">
                    <input type="text" name="q" class="form-control search-input" 
                           placeholder="ê±°ë˜ì²˜, ìš”ì²­ì, í’ˆëª©ëª… ë“±" 
                           value="{{ search_query }}">
                </div>

                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">ì¡°íšŒ</button>
                    <a href="?facility=ALL" class="btn btn-outline-secondary">ì´ˆê¸°í™”</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            {% if group_by == 'time' %}
            {# =================== ë°œì£¼ì‹œê°„ìˆœ ë¬¶ìŒ (ì‹ ê·œ) =================== #}
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-center">
                    <tr>
                        <th style="width: 50px;"><input type="checkbox" class="form-check-input" onchange="toggleAllChecks(this)"></th>
                        <th>ë°œì£¼ ì‹œê°„</th>
                        <th>ìƒì‚°ì¼</th>
                        <th>ê±°ë˜ì²˜</th>
                        <th>í’ˆëª©ëª…</th>
                        <th>ìš”ì²­ì</th>
                        <th>ë©”ëª¨</th>
                        <th>ìƒì‚°ë™</th>
                        <th>ì™„ë£Œìˆ˜ëŸ‰ / ìš”ì²­</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for line in results %}
                    <tr class="{% if line.status == 'COMPLETED' %}{% if line.fulfilled_quantity == line.requested_quantity %}table-green{% else %}table-red{% endif %} text-muted{% endif %}">
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input line-check" value="{{ line.id }}" {% if line.status == 'COMPLETED' %}disabled{% endif %}>
                        </td>
                        <td>{{ line.header.created_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ line.header.requested_delivery_date|date:"Y-m-d" }}</td>
                        <td class="text-truncate" title="{{ line.header.customer.name }}">{{ line.header.customer.name }}</td>
                        <td class="text-start">
                            <span class="fw-bold">{{ line.product.name }}</span><br>
                            <small class="text-muted">{{ line.product.sku }}</small>
                        </td>
                        <td class="fw-bold text-primary">{{ line.header.created_by.username|default:"-" }}</td>
                        <td class="text-start small text-muted text-truncate" title="{{ line.header.memo|default:'-' }}">{{ line.header.memo|default:"-" }}</td>
                        <td><span class="badge bg-info text-dark">{{ line.production_facility }}</span></td>
                        <td>
                            <div class="input-group input-group-sm">
                                <input type="number" id="qty-{{ line.id }}" 
                                    class="form-control text-end fw-bold {% if line.status == 'COMPLETED' %}{% if line.fulfilled_quantity == line.requested_quantity %}text-success{% else %}text-danger{% endif %}{% else %}text-success{% endif %}" 
                                    value="{{ line.fulfilled_quantity|default:0 }}" min="0" 
                                    {% if line.status == 'COMPLETED' %}disabled{% endif %}>
                                <span class="input-group-text">/ {{ line.requested_quantity }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex justify-content-center align-items-center gap-1">
                                <button class="btn btn-sm btn-outline-primary" onclick="openEditModal({{ line.id }}, {{ line.fulfilled_quantity|default:0 }}, '{{ line.header.memo|default:''|escapejs }}', '{{ line.production_facility }}', '{{ line.header.requested_delivery_date|date:'Y-m-d' }}')">âœï¸</button>
                                {% if line.status != 'COMPLETED' %}
                                    <button class="btn btn-sm btn-outline-success" onclick="completeLine({{ line.id }})">OK</button>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-secondary" disabled>ì™„ë£Œ</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="10" class="text-center py-5 text-muted">ê²€ìƒ‰ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            {# =================== ê·¸ë£¹ë³„ ë¬¶ìŒ (ê¸°ì¡´) =================== #}
            {% if group_by == 'product' %}
            {# =================== í’ˆëª©ë³„ ë¬¶ìŒ =================== #}
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-center">
                    <tr>
                        <th style="width: 50px;"><input type="checkbox" class="form-check-input" onchange="toggleAllChecks(this)"></th>
                        <th>í’ˆëª©ëª… (SKU)</th>
                        <th>ì´ ì‘ì—… ê±´ìˆ˜</th>
                        <th>ì´ ìš”ì²­ ìˆ˜ëŸ‰</th>
                        <th style="width: 100px;">ìƒì„¸ë³´ê¸°</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in results %}
                    <tr class="{% if group.group_status == 'PERFECT' %}table-green{% elif group.group_status == 'IMPERFECT' %}table-red{% elif group.group_status == 'PARTIAL' %}table-yellow{% else %}table-secondary{% endif %}">
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input group-check" onchange="toggleGroupChecks(this, 'group-product-{{ group.product.id }}')">
                        </td>
                        <td>
                            <span class="fw-bold fs-5">{{ group.product.name }}</span><br>
                            <small class="text-muted">{{ group.product.sku }}</small>
                            {% if group.group_status == 'PERFECT' %}<span class="badge bg-success ms-1">ì™„ë£Œ (ì •ìƒ)</span>
                            {% elif group.group_status == 'IMPERFECT' %}<span class="badge bg-danger ms-1">ì™„ë£Œ (ìˆ˜ëŸ‰ì°¨ì´)</span>
                            {% elif group.group_status == 'PARTIAL' %}<span class="badge bg-warning ms-1">ë¶€ë¶„ ì™„ë£Œ</span>
                            {% endif %}
                        </td>
                        <td class="text-center fw-bold">{{ group.lines|length }}ê±´</td>
                        <td class="text-center fw-bold text-primary fs-5">{{ group.total_qty }}ê°œ</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-dark" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-product-{{ group.product.id }}">
                                â–¼ í¼ì¹˜ê¸°
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="5" class="p-0 border-0">
                            <div class="collapse show" id="collapse-product-{{ group.product.id }}">
                                <div class="bg-white p-3 border-bottom">
                                    {% include 'production/status_table_inner.html' with lines=group.lines group_by=group_by %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center py-5 text-muted">ê²€ìƒ‰ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            {# =================== ê±°ë˜ì²˜ë³„ ë¬¶ìŒ =================== #}
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-center">
                    <tr>
                        <th style="width: 50px;"><input type="checkbox" class="form-check-input" onchange="toggleAllChecks(this)"></th>
                        <th>ê±°ë˜ì²˜ëª…</th>
                        <th>ì´ ì‘ì—… ê±´ìˆ˜</th>
                        <th>ì´ ìš”ì²­ ìˆ˜ëŸ‰</th>
                        <th style="width: 100px;">ìƒì„¸ë³´ê¸°</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in results %}
                    <tr class="{% if group.group_status == 'PERFECT' %}table-green{% elif group.group_status == 'IMPERFECT' %}table-red{% elif group.group_status == 'PARTIAL' %}table-yellow{% else %}table-secondary{% endif %}">
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input group-check" onchange="toggleGroupChecks(this, 'group-customer-{{ group.customer.id }}')">
                        </td>
                        <td>
                            <span class="fw-bold fs-5">{{ group.customer.name }}</span><br>
                            {% if group.group_status == 'PERFECT' %}<span class="badge bg-success ms-1">ì™„ë£Œ (ì •ìƒ)</span>
                            {% elif group.group_status == 'IMPERFECT' %}<span class="badge bg-danger ms-1">ì™„ë£Œ (ìˆ˜ëŸ‰ì°¨ì´)</span>
                            {% elif group.group_status == 'PARTIAL' %}<span class="badge bg-warning ms-1">ë¶€ë¶„ ì™„ë£Œ</span>
                            {% endif %}
                        </td>
                        <td class="text-center fw-bold">{{ group.lines|length }}ê±´</td>
                        <td class="text-center fw-bold text-primary fs-5">{{ group.total_qty }}ê°œ</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-dark" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-customer-{{ group.customer.id }}">
                                â–¼ í¼ì¹˜ê¸°
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="5" class="p-0 border-0">
                            <div class="collapse show" id="collapse-customer-{{ group.customer.id }}">
                                <div class="bg-white p-3 border-bottom">
                                    {% include 'production/status_table_inner.html' with lines=group.lines group_by=group_by %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center py-5 text-muted">ê²€ìƒ‰ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">âœï¸ ìˆ˜ì • ë° ì´ë ¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-line-id">
                <div class="p-3 mb-3 bg-white border rounded">
                    <h6 class="fw-bold border-bottom pb-2 mb-3">ğŸ› ï¸ ë‚´ìš© ìˆ˜ì •</h6>
                    <div class="mb-3">
                        <label class="form-label small text-muted">ìƒì‚°ì¼</label>
                        <input type="date" class="form-control" id="edit-delivery-date">
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">ì™„ë£Œ ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control fw-bold text-primary" id="edit-qty" min="0">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">ìƒì‚°ë™ ì´ë™</label>
                            <select class="form-select" id="edit-facility">
                                {% for fac in facility_list %}
                                    <option value="{{ fac }}">{{ fac }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small text-muted">ë©”ëª¨</label>
                        <textarea class="form-control" id="edit-memo" rows="2"></textarea>
                    </div>
                </div>
                <div class="p-3 bg-light border rounded">
                    <h6 class="fw-bold border-bottom pb-2 mb-2">ğŸ“‹ ë³€ê²½ ì´ë ¥</h6>
                    <ul class="list-group list-group-flush small" id="log-list" style="max-height: 150px; overflow-y: auto;"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="submitEdit()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">âœï¸ ì²´í¬ëœ í•­ëª© ì¼ê´„ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><span id="bulk-edit-count" class="fw-bold">0</span>ê°œì˜ í•­ëª©ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <div class="mb-3">
                    <label for="bulk-delivery-date" class="form-label">ìƒì‚°ì¼ ë³€ê²½ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)</label>
                    <input type="date" class="form-control" id="bulk-delivery-date">
                </div>
                <div class="mb-3">
                    <label for="bulk-facility" class="form-label">ìƒì‚°ë™ ë³€ê²½ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)</label>
                    <select class="form-select" id="bulk-facility">
                        <option value="">-- ìƒì‚°ë™ ì„ íƒ --</option>
                        {% for fac in facility_list %}
                            <option value="{{ fac }}">{{ fac }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitBulkEdit()">ì¼ê´„ ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="pendingModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">&#48120;&#49373;&#49328; &#47785;&#47197;</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
                    <div>
                        <label class="form-label small mb-1">&#44592;&#44036; &#54596;&#53552;</label>
                        <div class="d-flex gap-1 align-items-center">
                            <input type="date" id="pending-filter-date-from" class="form-control form-control-sm">
                            <span class="small text-muted">~</span>
                            <input type="date" id="pending-filter-date-to" class="form-control form-control-sm">
                        </div>
                    </div>
                    <div>
                        <label class="form-label small mb-1">&#44277;&#51109; &#54596;&#53552;</label>
                        <select id="pending-filter-facility" class="form-select form-select-sm">
                            <option value="ALL">&#51204;&#52404;</option>
                            {% for fac in facility_list %}
                                <option value="{{ fac }}">{{ fac }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-1">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadPendingSummary()">&#54596;&#53552; &#51201;&#50857;</button>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
                    <div>
                        <label class="form-label small mb-1">&#49440;&#53469; &#54637;&#47785; &#49373;&#49328;&#51068; &#48320;&#44221;</label>
                        <input type="date" id="pending-bulk-date" class="form-control form-control-sm">
                    </div>
                    <div>
                        <label class="form-label small mb-1">&#49440;&#53469; &#54637;&#47785; &#44277;&#51109; &#48320;&#44221;</label>
                        <select id="pending-bulk-facility" class="form-select form-select-sm">
                            <option value="">-- &#44277;&#51109; &#49440;&#53469; --</option>
                            {% for fac in facility_list %}
                                <option value="{{ fac }}">{{ fac }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-1">
                        <button class="btn btn-sm btn-primary" onclick="bulkUpdatePending()">&#49440;&#53469; &#51068;&#44204; &#49688;&#51221;</button>
                    </div>
                </div>

                <div id="pending-loading" class="text-center text-muted py-3">&#47196;&#46377;&#51473;...</div>
                <div id="pending-empty" class="text-center text-muted py-3" style="display: none;">&#48120;&#49373;&#49328; &#45236;&#50669;&#51060; &#50630;&#49845;&#45768;&#45796;.</div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th style="width: 40px;" class="text-center">
                                    <input type="checkbox" id="pending-check-all" class="form-check-input" onchange="togglePendingAll(this)">
                                </th>
                                <th style="width: 120px;">&#49373;&#49328;&#51068;</th>
                                <th>&#49345;&#54408;</th>
                                <th style="width: 120px;">&#44277;&#51109;</th>
                                <th style="width: 110px;" class="text-end">&#49688;&#47049;</th>
                                <th style="width: 90px;" class="text-center">&#44148;&#49688;</th>
                                <th style="width: 170px;">&#49373;&#49328;&#51068; &#48320;&#44221;</th>
                                <th style="width: 90px;"></th>
                            </tr>
                        </thead>
                        <tbody id="pending-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    function getCsrfToken() { const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]'); return tokenInput ? tokenInput.value : ''; }
    function toggleGroupChecks(source, groupClass) { document.querySelectorAll('.' + groupClass + ' .line-check:not([disabled])').forEach(cb => cb.checked = source.checked); }
    function toggleAllChecks(source) { document.querySelectorAll('.line-check:not([disabled])').forEach(cb => cb.checked = source.checked); }

    const axiosConfig = { headers: { 'X-CSRFToken': getCsrfToken() } };
    
    async function completeLine(lineId) {
        const qty = document.getElementById('qty-' + lineId).value;
        if (!confirm(`ìˆ˜ëŸ‰ ${qty}ê°œë¡œ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try { await axios.post(`../line/${lineId}/complete/`, { quantity: qty }, axiosConfig); location.reload(); } catch (err) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }
    
    async function completeBulk() {
        const ids = Array.from(document.querySelectorAll('.line-check:checked')).map(cb => parseInt(cb.value));
        if (ids.length === 0 || !confirm(`${ids.length}ê±´ ì¼ê´„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try { await axios.post('../lines/bulk_complete/', { ids: ids }, axiosConfig); location.reload(); } catch (err) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    const bulkEditModal = new bootstrap.Modal(document.getElementById('bulkEditModal'));

    function openBulkEditModal() {
        const selectedIds = Array.from(document.querySelectorAll('.line-check:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) {
            alert('ìˆ˜ì •í•  í•­ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        document.getElementById('bulk-edit-count').textContent = selectedIds.length;
        document.getElementById('bulk-delivery-date').value = '';
        document.getElementById('bulk-facility').value = '';
        bulkEditModal.show();
    }

    async function submitBulkEdit() {
        const ids = Array.from(document.querySelectorAll('.line-check:checked')).map(cb => parseInt(cb.value));
        const delivery_date = document.getElementById('bulk-delivery-date').value;
        const production_facility = document.getElementById('bulk-facility').value;

        if (!delivery_date && !production_facility) {
            alert('ë³€ê²½í•  ìƒì‚°ì¼ ë˜ëŠ” ìƒì‚°ë™ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!confirm(`${ids.length}ê°œ í•­ëª©ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        const payload = { ids };
        if (delivery_date) payload.delivery_date = delivery_date;
        if (production_facility) payload.production_facility = production_facility;
        
        try {
            await axios.post('../lines/bulk-update/', payload, axiosConfig);
            location.reload();
        } catch (err) {
            alert("ì˜¤ë¥˜: " + (err.response?.data?.error || "ì¼ê´„ ìˆ˜ì • ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
        }
    }

    async function openEditModal(lineId, currentQty, currentMemo, currentFacility, deliveryDate) {
        document.getElementById('edit-line-id').value = lineId;
        document.getElementById('edit-delivery-date').value = deliveryDate;
        document.getElementById('edit-qty').value = currentQty;
        document.getElementById('edit-memo').value = currentMemo;
        document.getElementById('edit-facility').value = currentFacility;
        editModal.show();
        
        const logList = document.getElementById('log-list');
        logList.innerHTML = '<li class="list-group-item bg-transparent text-center text-muted">ë¡œë”©ì¤‘...</li>';
        
        try {
            const res = await axios.get(`../line/${lineId}/logs/`);
            if (res.data.length === 0) logList.innerHTML = '<li class="list-group-item text-center text-muted">ì´ë ¥ ì—†ìŒ</li>';
            else logList.innerHTML = res.data.map(log => `<li class="list-group-item bg-transparent px-0 py-2"><strong>${log.change_type}</strong> <span class="text-muted small">${log.created_at_fmt}</span><br>${log.description}</li>`).join('');
        } catch (err) { logList.innerHTML = '<li class="text-danger text-center">ì¡°íšŒ ì‹¤íŒ¨</li>'; }
    }

    async function submitEdit() {
        if (!confirm("ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const payload = {
            fulfilled_quantity: document.getElementById('edit-qty').value,
            memo: document.getElementById('edit-memo').value,
            production_facility: document.getElementById('edit-facility').value,
            delivery_date: document.getElementById('edit-delivery-date').value
        };
        try { 
            await axios.post(`../line/${document.getElementById('edit-line-id').value}/update/`, payload, axiosConfig); 
            location.reload(); 
        } catch (err) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }
    const pendingModal = new bootstrap.Modal(document.getElementById('pendingModal'));
    const pendingTableBody = document.getElementById('pending-table-body');
    const pendingLoading = document.getElementById('pending-loading');
    const pendingEmpty = document.getElementById('pending-empty');
    const pendingFilterDateFrom = document.getElementById('pending-filter-date-from');
    const pendingFilterDateTo = document.getElementById('pending-filter-date-to');
    const pendingFilterFacility = document.getElementById('pending-filter-facility');
    const pendingBulkDate = document.getElementById('pending-bulk-date');
    const pendingBulkFacility = document.getElementById('pending-bulk-facility');
    const pendingCheckAll = document.getElementById('pending-check-all');

    const defaultPendingDate = "{{ selected_date }}";
    const defaultPendingFacility = "{{ selected_facility }}";

    function openPendingModal() {
        if (defaultPendingDate && defaultPendingDate !== 'ALL') {
            if (pendingFilterDateFrom && !pendingFilterDateFrom.value) {
                pendingFilterDateFrom.value = defaultPendingDate;
            }
            if (pendingFilterDateTo && !pendingFilterDateTo.value) {
                pendingFilterDateTo.value = defaultPendingDate;
            }
        }
        if (pendingFilterFacility && defaultPendingFacility) {
            pendingFilterFacility.value = defaultPendingFacility;
        }
        pendingModal.show();
        loadPendingSummary();
    }

    function togglePendingAll(source) {
        document.querySelectorAll('.pending-check').forEach(cb => {
            cb.checked = source.checked;
        });
    }

    function getPendingFilterParams() {
        const params = new URLSearchParams();
        if (pendingFilterDateFrom && pendingFilterDateFrom.value) {
            params.set('date_from', pendingFilterDateFrom.value);
        }
        if (pendingFilterDateTo && pendingFilterDateTo.value) {
            params.set('date_to', pendingFilterDateTo.value);
        }
        if (pendingFilterFacility && pendingFilterFacility.value && pendingFilterFacility.value !== 'ALL') {
            params.set('facility', pendingFilterFacility.value);
        }
        return params.toString();
    }

    async function loadPendingSummary() {
        pendingLoading.style.display = 'block';
        pendingEmpty.style.display = 'none';
        pendingTableBody.innerHTML = '';
        if (pendingCheckAll) pendingCheckAll.checked = false;

        try {
            const params = getPendingFilterParams();
            const url = params ? `/production/pending-summary/?${params}` : '/production/pending-summary/';
            const res = await axios.get(url);
            const items = res.data.items || [];

            if (items.length === 0) {
                pendingEmpty.style.display = 'block';
                return;
            }

            pendingTableBody.innerHTML = items.map(item => `
                <tr data-line-ids="${item.line_ids.join(',')}">
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input pending-check" data-line-ids="${item.line_ids.join(',')}">
                    </td>
                    <td>${item.date}</td>
                    <td>
                        <div class="fw-bold">${item.product_name}</div>
                        <div class="small text-muted">${item.product_sku}</div>
                    </td>
                    <td>${item.production_facility || '-'}</td>
                    <td class="text-end fw-bold">${item.total_qty}</td>
                    <td class="text-center">${item.line_count}</td>
                    <td>
                        <input type="date" class="form-control form-control-sm" value="${item.date}">
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="updatePendingDate(this)">ìˆ˜ì •</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            pendingEmpty.textContent = 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            pendingEmpty.style.display = 'block';
        } finally {
            pendingLoading.style.display = 'none';
        }
    }

    async function updatePendingDate(button) {
        const row = button.closest('tr');
        const ids = (row.dataset.lineIds || '')
            .split(',')
            .filter(Boolean)
            .map(id => parseInt(id, 10));
        const input = row.querySelector('input[type="date"]');
        const newDate = input ? input.value : '';

        if (!newDate || ids.length === 0) {
            alert('ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm(`${ids.length}ê±´ì˜ ìƒì‚°ì¼ì„ ${newDate}ë¡œ ë³€ê²½í• ê¹Œìš”?`)) return;

        try {
            await axios.post('/production/lines/bulk-update/', { ids: ids, delivery_date: newDate }, axiosConfig);
            await loadPendingSummary();
        } catch (err) {
            alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function collectPendingSelectedIds() {
        return Array.from(document.querySelectorAll('.pending-check:checked'))
            .flatMap(cb => (cb.dataset.lineIds || '').split(','))
            .filter(Boolean)
            .map(id => parseInt(id, 10));
    }

    async function bulkUpdatePending() {
        const ids = collectPendingSelectedIds();
        const deliveryDate = pendingBulkDate ? pendingBulkDate.value : '';
        const productionFacility = pendingBulkFacility ? pendingBulkFacility.value : '';

        if (ids.length === 0) {
            alert('ìˆ˜ì •í•  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
        }

        if (!deliveryDate && !productionFacility) {
            alert('ë³€ê²½í•  ê°’ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm(`${ids.length}ê±´ì„ ì¼ê´„ ìˆ˜ì •í• ê¹Œìš”?`)) return;

        const payload = { ids };
        if (deliveryDate) payload.delivery_date = deliveryDate;
        if (productionFacility) payload.production_facility = productionFacility;

        try {
            await axios.post('/production/lines/bulk-update/', payload, axiosConfig);
            await loadPendingSummary();
        } catch (err) {
            alert('ì¼ê´„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    const resetLink = document.querySelector('a[href="?facility=ALL"]');
    if (resetLink) resetLink.setAttribute('href', '?facility=ALL&date=ALL');

    // Real-time update checker
    document.addEventListener('DOMContentLoaded', () => {
        const lineCheckboxes = document.querySelectorAll('.line-check');
        let latestId = 0;
        if (lineCheckboxes.length > 0) {
            const ids = Array.from(lineCheckboxes).map(cb => parseInt(cb.value, 10));
            latestId = Math.max(...ids);
        }
        
        const notificationBar = document.getElementById('update-notification');
        const currentParams = new URLSearchParams(window.location.search);
        currentParams.set('latest_id', latestId);
        
        const checkUrl = `/production/status/check-updates/?${currentParams.toString()}`;

        let pollingInterval = null;

        function checkUpdates() {
            axios.get(checkUrl)
                .then(response => {
                    const count = response.data.new_items_count;
                    if (count > 0) {
                        notificationBar.innerHTML = `${count}ê°œì˜ ìƒˆë¡œìš´ ë°œì£¼ê°€ ìˆìŠµë‹ˆë‹¤. <a href="#" onclick="location.reload(); return false;" class="alert-link">ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³´ê¸°</a>`;
                        notificationBar.style.display = 'block';
                        if (pollingInterval) {
                            clearInterval(pollingInterval);
                        }
                    }
                })
                .catch(error => {
                    console.error("Error checking for updates:", error);
                    if (pollingInterval) {
                        clearInterval(pollingInterval); // Stop polling on error
                    }
                });
        }

        // Start polling after initial delay to allow other scripts to run
        pollingInterval = setInterval(checkUpdates, 15000); // Poll every 15 seconds
    });
</script>
{% endblock scripts %}