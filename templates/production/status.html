{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <h4 class="mb-3">ğŸ­ ìƒì‚° í˜„í™© (ìˆ˜ì£¼ì°½)</h4>

        <div class="card mb-3 shadow-sm">
            <div class="card-body row g-2">
                <div class="col-6">
                    <label class="form-label small fw-bold">ë‚©ê¸°ì¼</label>
                    <input type="date" id="search-date" class="form-control" onchange="loadSummary()">
                </div>
                <div class="col-6">
                    <label class="form-label small fw-bold">ìƒì‚°ë™</label>
                    <select id="search-facility" class="form-select" onchange="loadSummary()">
                        <option value="">ì „ì²´ë³´ê¸°</option>
                        <option value="Aë™">Aë™</option>
                        <option value="Bë™">Bë™</option>
                        <option value="Cë™">Cë™</option>
                        <option value="ì™¸ë¶€ê°€ê³µ">ì™¸ë¶€ê°€ê³µ</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="summary-container">
            </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-product-name">í’ˆëª© ìƒì„¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="detail-container">
                </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ ì„¤ì •
    document.getElementById('search-date').value = new Date().toISOString().split('T')[0];

    // 1. í’ˆëª©ë³„ ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function loadSummary() {
        const date = document.getElementById('search-date').value;
        const facility = document.getElementById('search-facility').value; // ìƒì‚°ë™ ê°’ ê°€ì ¸ì˜¤ê¸°
        const container = document.getElementById('summary-container');        
        try {
            
            const res = await axios.get(`/api/production/summary/?date=${date}&facility=${facility}`);
            const data = res.data;

            if (data.length === 0) {
                container.innerHTML = '<p class="text-center mt-5 text-muted">í•´ë‹¹ ë‚ ì§œì— ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = data.map(item => `
                <div class="card mb-2 shadow-sm" onclick="showDetail(${item.product__id}, '${item.product__name}')">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${item.product__name}</h6>
                            <small class="text-muted">ì™„ë£Œ í˜„í™©: ${item.total_fulfilled} / ${item.total_requested}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">ìƒì„¸ë³´ê¸°</span>
                    </div>
                </div>
            `).join('');
        } catch (e) { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"); }
    }

    // 2. íŠ¹ì • í’ˆëª©ì˜ ê±°ë˜ì²˜ë³„ ìƒì„¸ ë‚´ì—­ ë³´ê¸° (ìˆ˜ì •ëœ ë¡œì§)
    async function showDetail(productId, productName) {
        document.getElementById('modal-product-name').innerText = productName;
        const container = document.getElementById('detail-container');
        const date = document.getElementById('search-date').value;

        try {
            const res = await axios.get(`/api/production/detail/?date=${date}&product_id=${productId}`);
            const details = res.data;

            container.innerHTML = `
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ê±°ë˜ì²˜(ë°œì£¼ì)</th>
                            <th>ìš”ì²­/ì™„ë£Œ</th>
                            <th style="width: 100px">ìˆ˜ëŸ‰ì…ë ¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${details.map(item => `
                            <tr>
                                <td>
                                    <div class="fw-bold">${item.customer_name}</div>
                                    <small class="text-muted">${item.created_by} | ${item.facility || 'ë¯¸ì§€ì •'}</small>
                                </td>
                                <td>
                                    <span class="badge ${item.status === 'ì™„ë£Œ' ? 'bg-success' : 'bg-warning'}">${item.status}</span><br>
                                    ${item.fulfilled_qty} / ${item.requested_qty}
                                </td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control fulfill-input" 
                                            data-id="${item.line_id}" 
                                            placeholder="ìˆ˜ëŸ‰">
                                        <button class="btn btn-outline-primary" onclick="completeLine(${item.line_id}, this)">ğŸ†—</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="p-3">
                    <button class="btn btn-success w-100" onclick="completeAll()">ì„ íƒ í•­ëª© ì¼ê´„ ì™„ë£Œ ì²˜ë¦¬</button>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        } catch (e) { alert("ìƒì„¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
    }

    // ê°œë³„ ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜
    async function completeLine(lineId, btnElement) {
        const input = btnElement.previousElementSibling;
        const qty = parseInt(input.value);

        if (!qty || qty <= 0) return alert("ì™„ë£Œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");

        try {
            await axios.patch(`/api/production/line/${lineId}/complete/`, {
                fulfilled_quantity: qty
            }, { headers: { 'X-CSRFToken': '{{ csrf_token }}' } });
            
            alert("ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            // ëª¨ë‹¬ ë‹«ê³  ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
            loadSummary();
        } catch (e) { alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.response.data.error); }
    }

    window.onload = loadSummary;


    
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}